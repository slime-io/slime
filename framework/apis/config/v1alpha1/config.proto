syntax = "proto3";

package slime.config.v1alpha1;

option go_package = "slime.io/slime/framework/apis/config/v1alpha1";

message Global {
  string service = 1;
  string multicluster = 2;
  string istioNamespace = 3;
  string slimeNamespace = 4;
  Log log = 5;
  map<string, string> misc = 6;
  string istioRev = 7;
  bool strictRev = 8;
  // ConfigSource describes a source of configuration data for networking
  // rules, and other Istio configuration artifacts. Multiple data sources
  // can be configured for a single control plane.
  repeated ConfigSource configSources = 9;
  // specify the address of k8s api-server instead of default value
  string masterUrl = 10;
  // configRev is the value used by slime configController to fetch/filter configs
  // in format comma-separated revisions, e.g. "1-11-1,prod"
  // will add istioRev to configRev if it exists
  string configRev = 11;
  // control the maximum QPS to the master from this client
  ClientGoTokenBucket clientGoTokenBucket = 12;
  // if SelfResourceRev is specified, the value of SelfResourceRev will be patched to resources which generated by slime itself, just like serviceFence
  // smartlimiter/envoyplugin/pluginmanager is excluded because these envoyfilter are generated by users or higher-level services
  // envoyfilter/sidecar is excluded because these resources generated base on their owner resources
  string selfResourceRev = 13;
  // specify the istio-config-source from which we can get a configs-mirror of relevant istiod.
  ConfigSource istioConfigSource = 14;
  // deploy rev specified by user, used to define the deploy version of slime
  string deployRev = 15;
  // enable/disable convert serviceentry to istio res when configsource is specified
  bool enableConvertSeToIstioRes = 16;
}

message Log {
  string logLevel = 1;
  int32 klogLevel = 2;
  bool logRotate = 3;
  LogRotateConfig logRotateConfig = 4;
  bool enableQuote = 5;
  // define ilog scope level
  // default:info,xdsc:warn,mcpc:warn
  string ilogLevel = 6;
}

message LogRotateConfig {
  string filePath = 1;
  int32 maxSizeMB = 2;
  int32 maxBackups = 3;
  int32 maxAgeDay = 4;
  bool compress = 5;
}


message Prometheus_Source{
  enum Type{
    Value = 0;
    Group = 1;
  }
  message Handler{
    string query = 1;
    Type type = 2;
  }
  string address = 1;
  map<string, Handler> handlers = 2;
}

message K8S_Source{
  repeated string handlers = 1;
}

message Metric{
  Prometheus_Source prometheus = 1;
  K8S_Source k8s = 2;
}

// +kubebuilder:pruning:PreserveUnknownFields
message General {// general module
}

message Bundle {
  message Item {
    // submodule name, custom value, necessary
    string name = 1;
    // submodule kind, can only be one of real module kinds, like limiter, necessary
    string kind = 2;
  }
  repeated Item modules = 1;
}

message Config {

  Global global = 3;

  Metric metric = 6;
  string name = 5;
  bool enable = 7;
  General general = 8;  // general module config
  Bundle bundle = 9;

  string mode = 10;
  // like bundle item kind, necessary if not bundle
  string kind = 11;
}

// ConfigSource describes information about a configuration store inside a
// mesh. A single control plane instance can interact with one or more data
// sources.
message ConfigSource {
  // Address of the server implementing the Istio Mesh Configuration
  // protocol (MCP). Can be IP address or a fully qualified DNS name.
  // Use fs:/// to specify a file-based backend with absolute path to the directory.
  string address = 1;
}

message ClientGoTokenBucket {
  // QPS indicates the maximum QPS to the master from this client.
  int32 qps = 1;
  // Maximum burst for throttle.
  int32 burst = 2;
}